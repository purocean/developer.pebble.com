<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Vibrate on Disconnect // Pebble Developers</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="description" content="How to add bluetooth connection alerts to your watchface.
">
  <link rel="canonical" href="http://developer.getpebble.com/tutorials/watchface-tutorial/part5/">
  <link href="//fonts.googleapis.com/css?family=Open+Sans:400italic,400,300,600,700" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=Inconsolata:400,700" rel="stylesheet" type="text/css">
  <link href="/assets/favicon.png" rel="shortcut icon" type="image/vnd.microsoft.icon" id="favicon">
  <link rel="stylesheet" type="text/css" href="/assets/css/main.css">
  
  <noscript>
  <link rel="stylesheet" type="text/css" href="/assets/css/noscript.css">
  </noscript>
  
  <script type="text/javascript" >
    var _rollbarConfig = {
      accessToken: 'e1ecd52de5ba46c88e9f6f346a954c62',
      captureUncaught: true,
      payload: {
        environment: 'production'
      }
    };
    !function(a,b){function c(b){this.shimId=++h,this.notifier=null,this.parentShim=b,this.logger=function(){},a.console&&void 0===a.console.shimId&&(this.logger=a.console.log)}function d(b,c,d){a._rollbarWrappedError&&(d[4]||(d[4]=a._rollbarWrappedError),d[5]||(d[5]=a._rollbarWrappedError._rollbarContext),a._rollbarWrappedError=null),b.uncaughtError.apply(b,d),c&&c.apply(a,d)}function e(b){var d=c;return g(function(){if(this.notifier)return this.notifier[b].apply(this.notifier,arguments);var c=this,e="scope"===b;e&&(c=new d(this));var f=Array.prototype.slice.call(arguments,0),g={shim:c,method:b,args:f,ts:new Date};return a._rollbarShimQueue.push(g),e?c:void 0})}function f(a,b){if(b.hasOwnProperty&&b.hasOwnProperty("addEventListener")){var c=b.addEventListener;b.addEventListener=function(b,d,e){c.call(this,b,a.wrap(d),e)};var d=b.removeEventListener;b.removeEventListener=function(a,b,c){d.call(this,a,b&&b._wrapped?b._wrapped:b,c)}}}function g(a,b){return b=b||this.logger,function(){try{return a.apply(this,arguments)}catch(c){b("Rollbar internal error:",c)}}}var h=0;c.init=function(a,b){var e=b.globalAlias||"Rollbar";if("object"==typeof a[e])return a[e];a._rollbarShimQueue=[],a._rollbarWrappedError=null,b=b||{};var h=new c;return g(function(){if(h.configure(b),b.captureUncaught){var c=a.onerror;a.onerror=function(){var a=Array.prototype.slice.call(arguments,0);d(h,c,a)};var g,i,j="EventTarget,Window,Node,ApplicationCache,AudioTrackList,ChannelMergerNode,CryptoOperation,EventSource,FileReader,HTMLUnknownElement,IDBDatabase,IDBRequest,IDBTransaction,KeyOperation,MediaController,MessagePort,ModalWindow,Notification,SVGElementInstance,Screen,TextTrack,TextTrackCue,TextTrackList,WebSocket,WebSocketWorker,Worker,XMLHttpRequest,XMLHttpRequestEventTarget,XMLHttpRequestUpload".split(",");for(g=0;g<j.length;++g)i=j[g],a[i]&&a[i].prototype&&f(h,a[i].prototype)}return a[e]=h,h},h.logger)()},c.prototype.loadFull=function(a,b,c,d,e){var f=g(function(){var a=b.createElement("script"),e=b.getElementsByTagName("script")[0];a.src=d.rollbarJsUrl,a.async=!c,a.onload=h,e.parentNode.insertBefore(a,e)},this.logger),h=g(function(){var b;if(void 0===a._rollbarPayloadQueue){var c,d,f,g;for(b=new Error("rollbar.js did not load");c=a._rollbarShimQueue.shift();)for(f=c.args,g=0;g<f.length;++g)if(d=f[g],"function"==typeof d){d(b);break}}"function"==typeof e&&e(b)},this.logger);g(function(){c?f():a.addEventListener?a.addEventListener("load",f,!1):a.attachEvent("onload",f)},this.logger)()},c.prototype.wrap=function(b,c){try{var d;if(d="function"==typeof c?c:function(){return c||{}},"function"!=typeof b)return b;if(b._isWrap)return b;if(!b._wrapped){b._wrapped=function(){try{return b.apply(this,arguments)}catch(c){throw c._rollbarContext=d(),c._rollbarContext._wrappedSource=b.toString(),a._rollbarWrappedError=c,c}},b._wrapped._isWrap=!0;for(var e in b)b.hasOwnProperty(e)&&(b._wrapped[e]=b[e])}return b._wrapped}catch(f){return b}};for(var i="log,debug,info,warn,warning,error,critical,global,configure,scope,uncaughtError".split(","),j=0;j<i.length;++j)c.prototype[i[j]]=e(i[j]);var k="//d37gvrvc0wt4s1.cloudfront.net/js/v1.1/rollbar.min.js";_rollbarConfig.rollbarJsUrl=_rollbarConfig.rollbarJsUrl||k;var l=c.init(a,_rollbarConfig);l.loadFull(a,b,!1,_rollbarConfig)}(window,document);
  </script>
  <script type="text/javascript" async>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-30638158-4', 'auto');
    ga('send', 'pageview');
  </script>
  
</head>
<body class="">
  <div class="mmenu__wrapper">
    <div class="sidebar__wrapper sidebar__wrapper--sectionmenu">
  <div class="sidebar sidebar--narrow">
    <a href="/" class="sidebar__header">
      <span>pebble</span>
    </a>
    <ul class="mainmenu">
      <li class="mainmenu__item mainmenu__item--getting-started active"><a href="/tutorials/"><span>Tutorials</span></a></li>
<li class="mainmenu__item mainmenu__item--sdk"><a href="/sdk/"><span>Get the SDK</span></a></li>
<li class="mainmenu__item mainmenu__item--guides"><a href="/guides/"><span>Guides</span></a></li>
<li class="mainmenu__item mainmenu__item--docs"><a href="/docs/"><span>Documentation</span></a></li>
<li class="mainmenu__item mainmenu__item--examples"><a href="/examples/"><span>Examples</span></a></li>
<li class="mainmenu__item mainmenu__item--community"><a href="/community/"><span>Community</span></a></li>
<li class="mainmenu__item mainmenu__item--blog"><a href="/blog/"><span>Blog</span></a></li>
<li class="mainmenu__item mainmenu__item--more"><a href="/more/"><span>More</span></a></li>

    </ul>
    <div class="sidebar__legal">
      <a href="https://www.pebble.com/legal/privacy/" target="_blank">Privacy</a>
      <br>
      <a href="https://www.pebble.com/legal/cookies/" target="_blank">Cookies</a>
    </div>
    <a href="https://dev-portal.getpebble.com/" target="_blank" class="sidebar__footer">Publish</a>
  </div>
<div class="section-menu section-menu--getting-started section-menu--dark">
  <div class="section-menu__header">
    <h3><a href="/tutorials/">Tutorials</a></h3>
  </div>
  <ul>
    <li class="section-menu__item open"><a href="/tutorials/watchface-tutorial/part1/">Build a Watchface in C</a>
      <ul>
        <li class="section-menu__subitem"><a href="/tutorials/watchface-tutorial/part1/"><span>Part 1 - Displaying the Time</span></a></li>
        <li class="section-menu__subitem"><a href="/tutorials/watchface-tutorial/part2/"><span>Part 2 - Customizing the Watchface</span></a></li>
        <li class="section-menu__subitem"><a href="/tutorials/watchface-tutorial/part3/"><span>Part 3 - Adding Web Content</a></li>
        <li class="section-menu__subitem"><a href="/tutorials/watchface-tutorial/part4/"><span>Part 4 - Adding a Battery Bar</span></a></li>
        <li class="section-menu__subitem active"><a href="/tutorials/watchface-tutorial/part5/"><span>Part 5 - Vibrate on Disconnect</span></a></li>
      </ul>
    </li>

    <li class="section-menu__item"><a href="/tutorials/js-watchface-tutorial/part1/">Build a Watchface in JS</a>
      <ul>
        <li class="section-menu__subitem"><a href="/tutorials/js-watchface-tutorial/part1/"><span>Part 1 - Displaying the Time</span></a></li>
        <li class="section-menu__subitem"><a href="/tutorials/js-watchface-tutorial/part2/"><span>Part 2 - Adding Web Content</span></a></li>
      </ul>
    </li>

    <li class="section-menu__item"><a href="/tutorials/advanced/vector-animations/">Advanced Tutorials</a>
      <ul>
        <li class="section-menu__subitem"><a href="/tutorials/advanced/vector-animations/"><span>Vector Animations</span></a></li>
      </ul>
    </li>
  </ul>
</div>
</div><!-- sidebar__wrapper -->
<div class="content content--section-menu">
  <div class="search">
  <a  href="javascript:void(0);" class="mobile-nav__hamburger js-mobile-nav-toggle"><i class="fa fa-reorder"></i></a>
  <i class="fa fa-lg fa-search search__icon"></i><input type="search" id="quicksearch" placeholder="Search Developer Site">
</div>
<div class="quicksearch" style="display: none;" id="quicksearch__results"></div>
<div id="search__blackout" style="display: none;"></div>

  <div class="container">
  
<div class="visible-m visible-s visible-xs row">
  <div class="col-xs-12">
    <div class="form__group">
      <div class="select-style no-label">
        <select class="js-toc-select">
          
            <option value="what-39-s-next">What&#39;s Next?</option>
          
        </select>
      </div>
    </div>
  </div>
</div>


  <div class="row">
    <div class="col-l-8">
      <h1>Vibrate on Disconnect</h1>
      
      <div class="markdown markdown--staff">
      
      <div class="alert alert--bg-lightblue platform-choice platform-choice--large platform-choice--hidden">
  <p>
    This page contains some instructions that are different if you're using
    CloudPebble or if you're using the SDK locally on your computer.
  </p>
  <p>
    Select whether you're using CloudPebble or the SDK below to show the
    relevant instructions!
  </p>
  <div class="text-center">
    <a href="javascript:void();" class="platform-choice--link js-platform-choice" data-sdk-platform="cloudpebble">
      <img src="/assets/images/sdk/cloud.svg">
      <h4>CloudPebble</h4>
    </a>
    <a href="javascript:void();" class="platform-choice--link js-platform-choice" data-sdk-platform="local">
      <img src="/assets/images/sdk/sdk-box.svg">
      <h4>SDK</h4>
    </a>
  </div>
</div>
<div class="alert alert--bg-lightblue platform-choice platform-choice--small platform-choice--hidden">
  <p class="platform-specific" data-sdk-platform="cloudpebble">
    <img src="/assets/images/sdk/cloud.svg">
    Showing instructions for CloudPebble. <a href="javascript: void();" class="js-platform-choice" data-sdk-platform="local">Not using CloudPebble?</a>
  </p>
  <p class="platform-specific" data-sdk-platform="local">
    <img src="/assets/images/sdk/sdk-box.svg">
    Showing instructions for the SDK. <a href="javascript: void();" class="js-platform-choice" data-sdk-platform="cloudpebble">Using CloudPebble?</a>
  </p>
</div>

      
      <p>The final popular watchface addition explored in this tutorial series
is the concept of using the Bluetooth connection service to alert the user
when their watch connects or disconnects. This can be useful to know when the
watch is out of range and notifications will not be received, or to let the user
know that they might have walked off somewhere without their phone.</p><p>This section continues from
<a href="/tutorials/watchface-tutorial/part4" title="" class=""><em>Part 4</em></a>, so be sure to
re-use your code or start with that finished project.</p><p>In a similar manner to both the <a href="/docs/c/Foundation/Event_Service/TickTimerService/" title="TickTimerService" class="link--docs"><code>TickTimerService</code></a> and
<a href="/docs/c/Foundation/Event_Service/BatteryStateService/" title="BatteryStateService" class="link--docs"><code>BatteryStateService</code></a>, the events associated with the Bluetooth connection are
given to developers via subscriptions, which requires an additional callback -
the <a href="/docs/c/Foundation/Event_Service/ConnectionService/#ConnectionHandler" title="ConnectionHandler" class="link--docs"><code>ConnectionHandler</code></a>. Create one of these in the format given below:</p><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">bluetooth_callback</span><span class="p">(</span><span class="kt">bool</span> <span class="n">connected</span><span class="p">)</span> <span class="p">{</span>

<span class="p">}</span>
</pre></div><p>The subscription to Bluetooth-related events is added in <code>init()</code>:</p><div class="highlight"><pre><span class="c1">// Register for Bluetooth connection updates</span>
<span class="n">connection_service_subscribe</span><span class="p">((</span><span class="n">ConnectionHandlers</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">.</span><span class="n">pebble_app_connection_handler</span> <span class="o">=</span> <span class="n">bluetooth_callback</span>
<span class="p">});</span>
</pre></div><p>The indicator itself will take the form of the following &#39;Bluetooth
disconnected&#39; icon that will be displayed when the watch is disconnected, and
hidden when reconnected. Save the image below for use in this project:</p><p><img style="background-color: #CCCCCC;" src="/assets/images/tutorials/intermediate/bt-icon.png"</img></p>
<div class="platform-specific" data-sdk-platform="cloudpebble"><p>Add this icon to your project by clicking &#39;Add New&#39; under &#39;Resources&#39; in
the left hand side of the editor. Specify the &#39;Resource Type&#39; as &#39;Bitmap Image&#39;,
upload the file for the &#39;File&#39; field. Give it an &#39;Identifier&#39; such as
<code>IMAGE_BT_ICON</code> before clicking &#39;Save&#39;.</p></div>

<div class="platform-specific" data-sdk-platform="local"><p>Add this icon to your project by copying the above icon image to the <code>resources</code>
project directory, and adding a new JSON object to the <code>media</code> array in
<code>package.json</code> such as the following:</p><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">"type"</span><span class="o">:</span> <span class="s2">"bitmap"</span><span class="p">,</span>
  <span class="s2">"name"</span><span class="o">:</span> <span class="s2">"IMAGE_BT_ICON"</span><span class="p">,</span>
  <span class="s2">"file"</span><span class="o">:</span> <span class="s2">"bt-icon.png"</span>
<span class="p">},</span>
</pre></div></div>
<p>This icon will be loaded into the app as a <a href="/docs/c/Graphics/Graphics_Types/#GBitmap" title="GBitmap" class="link--docs"><code>GBitmap</code></a> for display in a
<a href="/docs/c/User_Interface/Layers/BitmapLayer/" title="BitmapLayer" class="link--docs"><code>BitmapLayer</code></a> above the time display. Declare both of these as pointers at the
top of the file, in addition to the existing variables of these types:</p><div class="highlight"><pre><span class="k">static</span> <span class="n">BitmapLayer</span> <span class="o">*</span><span class="n">s_background_layer</span><span class="p">,</span> <span class="o">*</span><span class="n">s_bt_icon_layer</span><span class="p">;</span>
<span class="k">static</span> <span class="n">GBitmap</span> <span class="o">*</span><span class="n">s_background_bitmap</span><span class="p">,</span> <span class="o">*</span><span class="n">s_bt_icon_bitmap</span><span class="p">;</span>
</pre></div><p>Allocate both of the new objects in <code>main_window_load()</code>, then set the
<a href="/docs/c/User_Interface/Layers/BitmapLayer/" title="BitmapLayer" class="link--docs"><code>BitmapLayer</code></a>&#39;s bitmap as the new icon <a href="/docs/c/Graphics/Graphics_Types/#GBitmap" title="GBitmap" class="link--docs"><code>GBitmap</code></a>:</p><div class="highlight"><pre><span class="c1">// Create the Bluetooth icon GBitmap</span>
<span class="n">s_bt_icon_bitmap</span> <span class="o">=</span> <span class="n">gbitmap_create_with_resource</span><span class="p">(</span><span class="n">RESOURCE_ID_IMAGE_BT_ICON</span><span class="p">);</span>

<span class="c1">// Create the BitmapLayer to display the GBitmap</span>
<span class="n">s_bt_icon_layer</span> <span class="o">=</span> <span class="n">bitmap_layer_create</span><span class="p">(</span><span class="n">GRect</span><span class="p">(</span><span class="mi">59</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">));</span>
<span class="n">bitmap_layer_set_bitmap</span><span class="p">(</span><span class="n">s_bt_icon_layer</span><span class="p">,</span> <span class="n">s_bt_icon_bitmap</span><span class="p">);</span>
<span class="n">layer_add_child</span><span class="p">(</span><span class="n">window_get_root_layer</span><span class="p">(</span><span class="n">window</span><span class="p">),</span> <span class="n">bitmap_layer_get_layer</span><span class="p">(</span><span class="n">s_bt_icon_layer</span><span class="p">));</span>
</pre></div><p>As usual, ensure that the memory allocated to create these objects is also freed
in <code>main_window_unload()</code>:</p><div class="highlight"><pre><span class="n">gbitmap_destroy</span><span class="p">(</span><span class="n">s_bt_icon_bitmap</span><span class="p">);</span>
<span class="n">bitmap_layer_destroy</span><span class="p">(</span><span class="n">s_bt_icon_layer</span><span class="p">);</span>
</pre></div><p>With the UI in place, the implementation of the <a href="/docs/c/Foundation/Event_Service/ConnectionService/#BluetoothConnectionHandler" title="BluetoothConnectionHandler" class="link--docs"><code>BluetoothConnectionHandler</code></a>
can be finished. Depending on the state of the connection when an event takes
place, the indicator icon is hidden or unhidden as required. A distinct
vibration is also triggered if the watch becomes disconnected, to differentiate
the feedback from that of a notification or phone call:</p><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">bluetooth_callback</span><span class="p">(</span><span class="kt">bool</span> <span class="n">connected</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Show icon if disconnected</span>
  <span class="n">layer_set_hidden</span><span class="p">(</span><span class="n">bitmap_layer_get_layer</span><span class="p">(</span><span class="n">s_bt_icon_layer</span><span class="p">),</span> <span class="n">connected</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">connected</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Issue a vibrating alert</span>
    <span class="n">vibes_double_pulse</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div><p>Upon initialization, the app will display the icon unless a re-connection event
occurs, and the current state is evaluated. Manually call the handler in
<code>main_window_load()</code> to display the correct initial state:</p><div class="highlight"><pre><span class="c1">// Show the correct state of the BT connection from the start</span>
<span class="n">bluetooth_callback</span><span class="p">(</span><span class="n">connection_service_peek_pebble_app_connection</span><span class="p">());</span>
</pre></div><p>With this last feature in place, running the app and disconnecting the Bluetooth
connection will cause the new indicator to appear, and the watch to vibrate
twice.</p><p><img src="/assets/images/tutorials/intermediate/bt.png" alt="bt" class="pebble-screenshot pebble-screenshot--steel-black" /></p><p class="platform-specific" data-sdk-platform="cloudpebble">You can create a new CloudPebble project from the completed project by
<a href="https://cloudpebble.net/ide/gist/ddd15cbe8b0986fda407" title="" class="">clicking here</a>.</p><p class="platform-specific" data-sdk-platform="local">You can see the finished project source code in
<a href="https://gist.github.com/pebble-gists/ddd15cbe8b0986fda407" title="" class="">this GitHub Gist</a>.</p><h2 id="what-39-s-next" class="anchor">What&#39;s Next?</h2><p>Now that you&#39;ve successfully built a feature rich watchface, it&#39;s time to
<a href="/guides/appstore-publishing/publishing-an-app/" title="" class="">publish it</a>!</p>
      </div>
    </div>
    <div class="col-m-4 hidden-s hidden-xs hidden-m">
      <div class="gray-box gray-box--fixed gray-box--scrollspy">
        
  <h3>Overview</h3>
  <ul class="toc">
    
      <li class="toc__item toc__item--level1"><a href="#what-39-s-next">What&#39;s Next?</a></li>
    
  </ul>

        
      </div>
    </div>
  </div>
</div>

</div>

    
  </div>
  <script type="text/javascript">
    var searchPrimary = '';
  </script>
  
  <script type="text/javascript" src="/assets/js/libs-ce98da7b5eecc97f976a3cad8e665a31.js"></script>
  
  <script type="text/javascript" src="/assets/js/templates.js"></script>
  <script type="text/javascript" src="/assets/js/app.js"></script>
  <script type="text/javascript" src="/assets/js/search.js"></script>
  <script type="text/javascript" src="/assets/js/quicksearch.js"></script>
  <script type="text/javascript" src="/assets/js/disqus.js"></script>
  
</body>
</html>
